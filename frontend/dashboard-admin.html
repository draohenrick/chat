<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Admin - Dplay Bot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <script>const BACKEND_URL='https://botdplay.onrender.com';</script>
</head>
<body>
<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <nav class="col-md-2 bg-dark sidebar p-0">
      <div class="list-group list-group-flush">
        <a href="admin.html" class="list-group-item list-group-item-action bg-dark text-white active">Dashboard Admin</a>
        <a href="users.html" class="list-group-item list-group-item-action bg-dark text-white">Usuários</a>
        <a href="connections.html" class="list-group-item list-group-item-action bg-dark text-white">Conexões</a>
        <a href="conversations.html" class="list-group-item list-group-item-action bg-dark text-white">Conversas</a>
        <a href="leads.html" class="list-group-item list-group-item-action bg-dark text-white">Leads</a>
        <a href="#" id="logoutAdminBtn" class="list-group-item list-group-item-action bg-dark text-white">Sair</a>
      </div>
    </nav>

    <!-- Main -->
    <main class="col-md-10 ms-sm-auto px-4 py-4">
      <h1>Dashboard Admin</h1>
      <div class="row mt-4" id="adminKpiCards">
        <!-- Cards de KPIs admin -->
      </div>
      <div class="row mt-4" id="adminCharts">
        <div class="col-md-6"><canvas id="chartUsers"></canvas></div>
        <div class="col-md-6"><canvas id="chartConnections"></canvas></div>
      </div>
      <div class="row mt-4" id="adminLogs">
        <!-- Logs recentes do sistema -->
      </div>
    </main>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
async function loadAdminDashboard() {
  const token = localStorage.getItem('adminToken');
  if (!token) return window.location.href = 'index.html';

  try {
    const res = await fetch(`${BACKEND_URL}/api/admin/dashboard`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if (!res.ok) throw new Error('Falha ao conectar ao backend');

    const data = await res.json();
    if (!data.success) return window.location.href = 'index.html';

    // KPIs
    const kpiCards = document.getElementById('adminKpiCards');
    kpiCards.innerHTML = `
      <div class="col-md-3 mb-3">
        <div class="card text-white bg-primary">
          <div class="card-body">
            <h5>Usuários Ativos</h5>
            <p>${data.kpis.activeUsers}</p>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card text-white bg-success">
          <div class="card-body">
            <h5>Leads Totais</h5>
            <p>${data.kpis.totalLeads}</p>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card text-white bg-warning">
          <div class="card-body">
            <h5>Conexões Ativas</h5>
            <p>${data.kpis.activeConnections}</p>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card text-white bg-danger">
          <div class="card-body">
            <h5>Bot Online</h5>
            <p>${data.kpis.botStatus ? 'Sim' : 'Não'}</p>
          </div>
        </div>
      </div>
    `;

    // Gráficos
    const ctxUsers = document.getElementById('chartUsers').getContext('2d');
    new Chart(ctxUsers, {
      type: 'line',
      data: {
        labels: data.charts.users.labels,
        datasets: [{
          label: 'Usuários',
          data: data.charts.users.values,
          backgroundColor: 'rgba(0,123,255,0.2)',
          borderColor: 'rgba(0,123,255,1)',
          borderWidth: 2
        }]
      }
    });

    const ctxConnections = document.getElementById('chartConnections').getContext('2d');
    new Chart(ctxConnections, {
      type: 'line',
      data: {
        labels: data.charts.connections.labels,
        datasets: [{
          label: 'Conexões',
          data: data.charts.connections.values,
          backgroundColor: 'rgba(255,102,0,0.2)',
          borderColor: 'rgba(255,102,0,1)',
          borderWidth: 2
        }]
      }
    });

    // Logs
    const logsDiv = document.getElementById('adminLogs');
    logsDiv.innerHTML = `
      <h4>Logs Recentes</h4>
      <ul class="list-group mt-2">
        ${data.logs.map(log => `<li class="list-group-item">${log}</li>`).join('')}
      </ul>
    `;

  } catch (err) {
    console.error(err);
    alert('Erro ao carregar dashboard admin');
  }
}

// Logout
document.getElementById('logoutAdminBtn').addEventListener('click', () => {
  localStorage.removeItem('adminToken');
  window.location.href = 'index.html';
});

// Carregar dashboard ao abrir a página
loadAdminDashboard();
</script>
</body>
</html>
